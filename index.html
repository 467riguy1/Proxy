<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimalist Proxy</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple load animation for the button */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div class="flex flex-col items-center justify-center min-h-screen p-4">
        
        <h1 class="text-5xl font-bold text-white mb-4">
            Proxy
        </h1>
        <p class="text-lg text-gray-400 mb-8">
            Search freely.
        </p>

        <!-- Proxy Form -->
        <form id="proxy-form" class="w-full max-w-xl">
            <div class="flex items-center bg-gray-800 border border-gray-700 rounded-lg shadow-lg overflow-hidden p-2">
                <input 
                    type="text" 
                    id="url-input"
                    placeholder="Search or enter a URL" 
                    class="w-full bg-transparent text-white placeholder-gray-500 text-lg px-4 py-3 border-none outline-none"
                    aria-label="Search or enter URL">
                
                <button 
                    type="submit" 
                    id="proxy-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg rounded-md px-6 py-3 transition-colors duration-200 ease-in-out flex items-center justify-center min-w-[100px]">
                    <span id="button-text">Go</span>
                    <div id="button-loader" class="loader hidden"></div>
                </button>
            </div>
        </form>

        <!-- Error Message Box -->
        <div id="error-message" class="hidden mt-4 w-full max-w-xl bg-red-800 border border-red-700 text-red-100 px-4 py-3 rounded-lg" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-text" class="block sm:inline"></span>
        </div>
        
    </div>

    <!-- 
        Load the Ultraviolet core bundle. 
        Note: The uv.config.js is no longer loaded here; the config is now defined directly in the scripts.
    -->
    <script src="https://unpkg.com/@titaniumnetwork-dev/ultraviolet@latest/dist/uv.bundle.js" defer></script>

    <script>
        // Define the configuration globally for the main thread (for encoding the URL)
        // This must match the config defined inside the service worker.
        window.__uv$config = {
            // This is the path under which the proxied site will run
            prefix: '/uv/',
            // Use Ultraviolet's recommended XOR encoding for URL obfuscation
            encodeUrl: Ultraviolet.codec.xor.encode,
            decodeUrl: Ultraviolet.codec.xor.decode,
        };

        window.onload = function() {
            const form = document.getElementById('proxy-form');
            const input = document.getElementById('url-input');
            const button = document.getElementById('proxy-button');
            const buttonText = document.getElementById('button-text');
            const buttonLoader = document.getElementById('button-loader');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            // Start the service worker registration
            registerServiceWorker().catch(err => {
                showError("Initialization Failed: " + err.message);
                console.error("Initialization Error:", err);
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const url = input.value.trim();

                if (!url) {
                    showError("Please enter a URL or search term.");
                    return;
                }
                
                // Show loading spinner
                setLoading(true);
                hideError();

                try {
                    // Encode the URL using the Ultraviolet function defined in the global config
                    const encodedUrl = window.__uv$config.prefix + window.__uv$config.encodeUrl(search(url));
                    
                    // Redirect the user to the proxied URL
                    location.href = encodedUrl;

                } catch (err) {
                    setLoading(false);
                    showError("URL encoding failed. Ensure the proxy initialized correctly.");
                    console.error("Encoding/Redirection failed:", err);
                }
            });

            function setLoading(isLoading) {
                if (isLoading) {
                    buttonText.classList.add('hidden');
                    buttonLoader.classList.remove('hidden');
                    button.disabled = true;
                    input.disabled = true;
                } else {
                    buttonText.classList.remove('hidden');
                    buttonLoader.classList.add('hidden');
                    button.disabled = false;
                    input.disabled = false;
                }
            }
            
            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }
            
            function hideError() {
                errorMessage.classList.add('hidden');
            }

            /**
             * Registers the Service Worker using an inline Blob to ensure correct origin and scope.
             */
            async function registerServiceWorker() {
                if (!navigator.serviceWorker) {
                    throw new Error("Your browser does not support Service Workers.");
                }

                // Configuration for the proxy engine
                const UV_CDN_BASE = 'https://unpkg.com/@titaniumnetwork-dev/ultraviolet@latest/dist/';
                // The Bare Server is the actual proxy backend. We must use a public one for this client-side implementation.
                const BARE_SERVER_URL = 'https://tomp.bare-server.com/'; 
                
                // 1. Define the Service Worker script content as a string.
                // This is the functional equivalent of the uv.sw.js file.
                const swContent = `
                    // Service Worker Script Content (running in its own context)
                    
                    // 1. Define the config object (MUST be defined in the worker scope)
                    self.__uv$config = {
                        prefix: '/uv/',
                        bare: '${BARE_SERVER_URL}', 
                        encodeUrl: Ultraviolet.codec.xor.encode,
                        decodeUrl: Ultraviolet.codec.xor.decode,
                        handler: '${UV_CDN_BASE}uv.handler.js',
                        bundle: '${UV_CDN_BASE}uv.bundle.js',
                        config: '${UV_CDN_BASE}uv.config.js',
                        sw: '${UV_CDN_BASE}uv.sw.js',
                    };

                    // 2. Import the required UV scripts from the CDN
                    // These provide the UVServiceWorker class and the core logic
                    importScripts(self.__uv$config.bundle);
                    importScripts(self.__uv$config.handler);

                    // 3. Register the Service Worker (the UV way)
                    const proxy = new UVServiceWorker(self.__uv$config);

                    // 4. Listen for fetch requests and handle them using the UV proxy
                    self.addEventListener('fetch', event => {
                        event.respondWith(proxy.fetch(event));
                    });

                    // Ensure immediate activation
                    self.addEventListener('install', () => self.skipWaiting());
                    self.addEventListener('activate', event => event.waitUntil(clients.claim()));
                `;
                
                // 2. Create a Blob from the content
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                try {
                    // 3. Register the Service Worker using the Blob URL. 
                    // The scope MUST match the prefix defined in the config.
                    const registration = await navigator.serviceWorker.register(swUrl, {
                        scope: '/uv/' 
                    });

                    // 4. Revoke the Blob URL once the service worker is active (for cleanup)
                    registration.addEventListener('updatefound', () => {
                        const installingWorker = registration.installing;
                        installingWorker.addEventListener('statechange', () => {
                            if (installingWorker.state === 'activated') {
                                URL.revokeObjectURL(swUrl);
                            }
                        });
                    });
                    
                    console.log("Service Worker registered successfully with Blob URL scope.");
                    return registration;
                } catch (e) {
                    console.error("Service Worker registration failed:", e);
                    throw new Error(`Failed to register Service Worker.`);
                }
            }

            /**
             * Checks if a string is a URL, otherwise treats it as a search query.
             */
            function search(input) {
                input = input.trim();
                try {
                    // Check if input is a valid URL by attempting to create a URL object
                    const url = new URL(input);
                    // If it has a scheme, return it
                    return url.href;
                } catch (e) {
                    // If URL creation fails, assume it's missing a protocol or is a search term.
                    if (input.includes('.') && !input.includes(' ')) {
                         // Assume it's a domain missing protocol (e.g., "youtube.com")
                         return 'https://' + input;
                    }
                    // Treat as a search query
                    return 'https://www.google.com/search?q=' + encodeURIComponent(input);
                }
            }

            // Clear loading state on page load (for back button navigation)
            setLoading(false);
        };
    </script>
</body>
</html>
